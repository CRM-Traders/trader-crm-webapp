<div class="w-full">
  <!-- Modal Header -->
  <div *ngIf="orderData" class="mb-6">
    <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">
      Edit Order
    </h3>
    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
      Order ID: {{ orderData.orderId || orderData.id }}
      <span
        class="ml-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
        [ngClass]="{
          'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100':
            orderData.status === 1 || orderData.status === 2,
          'bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100':
            orderData.status === 3,
          'bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100':
            orderData.status === 4 ||
            orderData.status === 5 ||
            orderData.status === 6
        }"
      >
        {{ getOrderStatus(orderData.status) }}
      </span>
    </p>
  </div>

  <!-- Loading State -->
  <div *ngIf="loadingData" class="flex items-center justify-center h-[400px]">
    <div class="text-center">
      <div
        class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"
      ></div>
      <p class="text-gray-600 dark:text-gray-400">Loading order details...</p>
    </div>
  </div>

  <!-- Order Details -->
  <div
    *ngIf="!loadingData && orderData"
    class="grid grid-cols-1 lg:grid-cols-2 gap-6"
  >
    <!-- Left Side: TradingView Chart -->
    <div class="chart-section">
      <div class="chart-wrapper h-[800px]">
        <app-trading-view-chart
          [symbol]="currentSymbol() || 'BTCUSDT'"
          [interval]="'5'"
          [hideTopToolbar]="false"
          [hideSideToolbar]="true"
          [hideLegend]="false"
          [hideVolume]="false"
          [allowSymbolChange]="true"
          [autosize]="true"
          (parseEventData)="onChartEvent($event)"
        ></app-trading-view-chart>
      </div>
    </div>

    <!-- Right Side: Order Form -->
    <div class="form-section">
      <form [formGroup]="editForm" class="space-y-4">
        <!-- Row: Side, Status, Reason -->
        <div class="grid grid-cols-3 gap-4">
          <!-- Side -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Side
            </label>
            <div *ngIf="isEditing" class="grid grid-cols-2 gap-2">
              <label
                *ngFor="let option of sideOptions"
                class="flex items-center justify-center p-2.5 border rounded-lg cursor-pointer transition-all"
                [ngClass]="{
                  'border-blue-500 bg-blue-50 dark:bg-blue-900/20':
                    editForm.get('side')?.value === option.value,
                  'border-gray-300 dark:border-gray-600 hover:border-gray-400':
                    editForm.get('side')?.value !== option.value
                }"
              >
                <input
                  type="radio"
                  formControlName="side"
                  [value]="option.value"
                  class="sr-only"
                />
                <span
                  class="text-sm font-medium"
                  [ngClass]="
                    editForm.get('side')?.value === option.value
                      ? 'text-blue-600 dark:text-blue-400'
                      : option.class
                  "
                >
                  {{ option.label }}
                </span>
              </label>
            </div>
            <span
              *ngIf="!isEditing"
              class="inline-flex items-center px-3 py-2.5 rounded-md text-sm font-medium"
              [ngClass]="{
                'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100':
                  orderData.side === 1,
                'bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100':
                  orderData.side === 2
              }"
            >
              {{ getOrderSide(orderData.side) }}
            </span>
          </div>

          <!-- Status -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Status
            </label>
            <select
              *ngIf="isEditing"
              formControlName="status"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option
                *ngFor="let option of statusOptions"
                [value]="option.value"
              >
                {{ option.label }}
              </option>
            </select>
            <span
              *ngIf="!isEditing"
              class="inline-flex items-center px-3 py-2.5 rounded-md text-sm font-medium"
              [ngClass]="{
                'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100':
                  orderData.status === 1 || orderData.status === 2,
                'bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100':
                  orderData.status === 3,
                'bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100':
                  orderData.status === 4 ||
                  orderData.status === 5 ||
                  orderData.status === 6
              }"
            >
              {{ getOrderStatus(orderData.status) }}
            </span>
          </div>

          <!-- Reason -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Reason
            </label>
            <input
              *ngIf="isEditing"
              type="text"
              formControlName="reason"
              placeholder="Enter reason"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
            >
              {{ orderData.reason || "-" }}
            </span>
          </div>
        </div>

        <!-- Toggle for Amount (like quick-order) -->
        <div class="flex items-center gap-3">
          <label class="flex items-center cursor-pointer">
            <input
              type="checkbox"
              [checked]="useAmount()"
              (change)="useAmount.set($any($event.target).checked)"
              class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
            />
            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">
              Use Amount (Auto-calculate from cash amount)
            </span>
          </label>
        </div>

        <!-- Row: Amount & Currency -->
        <div *ngIf="useAmount()" class="grid grid-cols-2 gap-4">
          <div>
            <div class="flex items-center gap-2 mb-2">
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >
                Amount
                <span
                  *ngIf="calculatingFromAmount()"
                  class="ml-2 text-xs text-blue-600"
                  >Calculating...</span
                >
              </label>
            </div>
            <input
              *ngIf="isEditing"
              type="number"
              formControlName="amount"
              (input)="onAmountInput($any($event.target).value)"
              (keydown)="preventInvalidNumberInput($event)"
              step="0.01"
              min="0"
              placeholder="Enter amount (e.g., 204.09)"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
            >
              {{ editForm.get("amount")?.value || "-" }}
            </span>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
              Auto-fills volume, open price, P/L and margins.
            </p>
          </div>

          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Currency
            </label>
            <select
              *ngIf="isEditing"
              formControlName="paymentCurrency"
              (change)="onPaymentCurrencyChange($any($event.target).value)"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
            </select>
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
            >
              {{ editForm.get("paymentCurrency")?.value || "USD" }}
            </span>
          </div>
        </div>

        <!-- Row: Volume & Symbol -->
        <div class="grid grid-cols-3 gap-4">
          <!-- Volume -->
          <div>
            <div class="flex items-center gap-2 mb-2">
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >
                Volume
                <span
                  *ngIf="calculatingFromVolume()"
                  class="ml-2 text-xs text-blue-600"
                  >Calculating...</span
                >
              </label>
              <input
                type="checkbox"
                [checked]="useVolume()"
                (change)="useVolume.set($any($event.target).checked)"
                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                title="Include Volume in calculations"
              />
            </div>
            <input
              *ngIf="isEditing"
              type="number"
              formControlName="volume"
              (input)="onVolumeInput($any($event.target).value)"
              (keydown)="preventInvalidNumberInput($event)"
              step="0.00000001"
              min="0"
              placeholder="Enter volume"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
            >
              {{ orderData.volume }}
            </span>
          </div>

          <!-- Stop Loss -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Stop Loss
            </label>
            <input
              *ngIf="isEditing"
              type="number"
              formControlName="stopLoss"
              (keydown)="preventInvalidNumberInput($event)"
              step="0.00000001"
              min="0"
              placeholder="Enter stop loss"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
            >
              {{
                orderData.stopLoss ?? orderData.stopPrice
                  ? "$" +
                    (orderData.stopLoss ?? orderData.stopPrice
                      | number : "1.8-8")
                  : "-"
              }}
            </span>
          </div>
          <!-- Take Profit -->
          <div>
            <div class="flex items-center gap-2 mb-2">
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >
                Take Profit
              </label>
            </div>
            <input
              *ngIf="isEditing"
              type="number"
              formControlName="takeProfit"
              (keydown)="preventInvalidNumberInput($event)"
              step="0.00000001"
              min="0"
              placeholder="Enter take profit"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
            >
              {{
                editForm.get("takeProfit")?.value
                  ? "$" + (editForm.get("takeProfit")?.value | number : "1.8-8")
                  : "-"
              }}
            </span>
          </div>
        </div>

        <!-- Row: Stop Loss & Take Profit -->
        <div class="grid grid-cols-2 gap-4">
          <!-- Leverage -->
          <div>
            <div class="flex items-center gap-2 mb-2">
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >
                Leverage
              </label>
              <span
                *ngIf="calculatingFromProfit() && profitCalcSource() === 'leverage'"
                class="ml-2 text-xs text-blue-600"
                >Calculating...</span
              >
              <input
                type="checkbox"
                [checked]="useLeverage()"
                (change)="useLeverage.set($any($event.target).checked)"
                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                title="Include Leverage in calculations"
              />
            </div>
            <input
              *ngIf="isEditing"
              type="number"
              formControlName="leverage"
              (input)="onLeverageChange($any($event.target).value)"
              min="1"
              placeholder="Enter leverage"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
            >
              {{ editForm.get("leverage")?.value || 1 }}x
            </span>
          </div>
          <!-- Target Profit -->
          <div>
            <div class="flex items-center gap-2 mb-2">
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >
                Target Profit
                <span
                  *ngIf="calculatingFromProfit() && profitCalcSource() === 'target'"
                  class="ml-2 text-xs text-blue-600"
                  >Calculating...</span
                >
              </label>
              <input
                type="checkbox"
                [checked]="useTargetProfit()"
                (change)="useTargetProfit.set($any($event.target).checked)"
                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                title="Include Target Profit in calculations"
              />
            </div>
            <input
              *ngIf="isEditing"
              type="number"
              formControlName="targetProfit"
              step="0.01"
              (input)="onTargetProfitInput($any($event.target).value)"
              (keydown)="preventInvalidNumberInput($event)"
              placeholder="Enter target profit"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white font-mono"
            >
              {{
                editForm.get("targetProfit")?.value != null
                  ? "$" +
                    (editForm.get("targetProfit")?.value | number : "1.2-8")
                  : "-"
              }}
            </span>
            <!-- <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
              Prefilled from realized P/L; sent as target profit on save.
            </p> -->
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <!-- Open Price -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Open Price
            </label>
            <div *ngIf="isEditing" class="flex gap-2 items-start">
              <div class="flex-1 relative">
                <div
                  class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                >
                  <span class="text-gray-500 dark:text-gray-400 text-sm"
                    >$</span
                  >
                </div>
                <input
                  type="number"
                  formControlName="openPrice"
                  (input)="onOpenPriceInput($any($event.target).value)"
                  (keydown)="preventInvalidNumberInput($event)"
                  step="0.00000001"
                  min="0"
                  placeholder="Enter open price"
                  class="block w-full !pl-7 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <button
                type="button"
                (click)="updatePrice()"
                [disabled]="!currentSymbol()"
                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors whitespace-nowrap"
              >
                Update
              </button>
            </div>
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white font-mono"
            >
              ${{ orderData.openPrice ?? orderData.price | number : "1.8-8" }}
            </span>
          </div>
          <!-- Position Open Time -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Position Open Time
            </label>
            <input
              *ngIf="isEditing"
              type="datetime-local"
              formControlName="positionOpenTime"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
            >
              {{
                orderData.positionOpenTime
                  ? (orderData.positionOpenTime | date : "medium")
                  : "-"
              }}
            </span>
          </div>
        </div>

        <!-- Row: Close Price & Position Open Time -->
        <div class="grid grid-cols-2 gap-4">
          <!-- Close Price -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Close Price
            </label>
            <div *ngIf="isEditing" class="flex gap-2 items-start">
              <div class="flex-1 relative">
                <div
                  class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                >
                  <span class="text-gray-500 dark:text-gray-400 text-sm"
                    >$</span
                  >
                </div>
                <input
                  type="number"
                  formControlName="closePrice"
                  (input)="onClosePriceInput($any($event.target).value)"
                  (keydown)="preventInvalidNumberInput($event)"
                  step="0.00000001"
                  min="0"
                  placeholder="Enter close price"
                  class="block w-full !pl-7 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <button
                type="button"
                (click)="updateClosePrice()"
                [disabled]="!currentSymbol()"
                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors whitespace-nowrap"
              >
                Update
              </button>
            </div>
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white font-mono"
            >
              {{
                orderData.closePrice
                  ? "$" + (orderData.closePrice | number : "1.8-8")
                  : "-"
              }}
            </span>
          </div>
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Position Close Time
            </label>
            <input
              *ngIf="isEditing"
              type="datetime-local"
              formControlName="positionCloseTime"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
            >
              {{
                orderData.positionCloseTime
                  ? (orderData.positionCloseTime | date : "medium")
                  : "-"
              }}
            </span>
          </div>
        </div>

        <!-- Row: Commission & Swap -->
        <div class="grid grid-cols-2 gap-4">
          <!-- Commission -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Commission
            </label>
            <div *ngIf="isEditing" class="relative">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <span class="text-gray-500 dark:text-gray-400 text-sm">$</span>
              </div>
              <input
                type="number"
                formControlName="commission"
                (keydown)="preventInvalidNumberInput($event)"
                step="0.00000001"
                min="0"
                placeholder="Enter commission"
                class="block w-full !pl-7 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white font-mono"
            >
              {{
                orderData.commission
                  ? "$" + (orderData.commission | number : "1.8-8")
                  : "-"
              }}
            </span>
          </div>

          <!-- Swap -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Swap
            </label>
            <div *ngIf="isEditing" class="relative">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <span class="text-gray-500 dark:text-gray-400 text-sm">$</span>
              </div>
              <input
                type="number"
                formControlName="swap"
                (keydown)="preventInvalidNumberInput($event)"
                step="0.00000001"
                placeholder="Enter swap"
                class="block w-full !pl-7 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white font-mono"
            >
              {{
                orderData.swap ?? orderData.swaps
                  ? "$" + (orderData.swap ?? orderData.swaps | number : "1.8-8")
                  : "-"
              }}
            </span>
          </div>
        </div>

        <!-- Row: Position Close Time -->
        <div class="grid grid-cols-2 gap-4"></div>

        <!-- Row: P/L, Margin & Target Profit -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- P/L -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              P/L
            </label>
            <input
              type="text"
              [value]="
                editForm.get('realizedPnL')?.value != null
                  ? '$' +
                    (editForm.get('realizedPnL')?.value | number : '1.2-8')
                  : '-'
              "
              readonly
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-50 dark:bg-gray-800 cursor-not-allowed"
              [ngClass]="{
                '!text-red-500': editForm.get('realizedPnL')?.value < 0,
                '!text-green-500': editForm.get('realizedPnL')?.value > 0
              }"
            />
          </div>

          <!-- Margin -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Margin
            </label>
            <input
              type="text"
              [value]="
                orderData.positionMargin
                  ? '$' + (orderData.positionMargin | number : '1.4-4')
                  : '-'
              "
              readonly
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-50 dark:bg-gray-800 cursor-not-allowed"
              [ngClass]="{
                '!text-red-500': orderData.positionMargin < 0,
                '!text-green-500': orderData.positionMargin > 0
              }"
            />
          </div>

          <!-- Symbol -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Symbol
            </label>
            <input
              type="text"
              formControlName="symbol"
              placeholder="Enter symbol"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-gray-100 cursor-not-allowed"
            />
          </div>
        </div>
      </form>

      <!-- Modal Footer -->
      <div
        class="mt-8 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3"
      >
        <button
          *ngIf="isEditing"
          type="button"
          class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md transition-colors disabled:opacity-50"
          [disabled]="editForm.invalid || loading"
          (click)="saveOrder()"
        >
          {{ loading ? "Saving..." : "Save Changes" }}
        </button>

        <button
          type="button"
          class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
          (click)="cancelEdit()"
          [disabled]="loading"
        >
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Reopen Order Modal -->
  <div
    *ngIf="showReopenModal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
    (click)="closeReopenModal()"
  >
    <div
      class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4"
      (click)="$event.stopPropagation()"
    >
      <!-- Modal Header -->
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
          Reopen Order
        </h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
          Order ID: {{ orderData?.id }}
        </p>
      </div>

      <!-- Modal Body -->
      <div class="px-6 py-6">
        <form [formGroup]="reopenForm" class="space-y-4">
          <!-- Apply New Outcome -->
          <div class="flex items-center">
            <input
              type="checkbox"
              id="applyNewOutcome"
              formControlName="applyNewOutcome"
              class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
            />
            <label
              for="applyNewOutcome"
              class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              Apply New Outcome
            </label>
          </div>

          <!-- New Desired PnL -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
            >
              New Desired PnL <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              formControlName="newDesiredPnL"
              step="0.01"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
              [class.border-red-500]="
                reopenForm.get('newDesiredPnL')?.invalid &&
                reopenForm.get('newDesiredPnL')?.touched
              "
            />
            <p
              class="mt-1 text-sm text-red-600 dark:text-red-400"
              *ngIf="
                reopenForm.get('newDesiredPnL')?.invalid &&
                reopenForm.get('newDesiredPnL')?.touched
              "
            >
              New Desired PnL is required
            </p>
          </div>

          <!-- New Close Price -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
            >
              New Close Price <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              formControlName="newClosePrice"
              step="0.00000001"
              min="0"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
              [class.border-red-500]="
                reopenForm.get('newClosePrice')?.invalid &&
                reopenForm.get('newClosePrice')?.touched
              "
            />
            <p
              class="mt-1 text-sm text-red-600 dark:text-red-400"
              *ngIf="
                reopenForm.get('newClosePrice')?.invalid &&
                reopenForm.get('newClosePrice')?.touched
              "
            >
              New Close Price is required and must be positive
            </p>
          </div>

          <!-- Reason -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
            >
              Reason <span class="text-red-500">*</span>
            </label>
            <textarea
              formControlName="reason"
              rows="3"
              placeholder="Enter reason for reopening"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none"
              [class.border-red-500]="
                reopenForm.get('reason')?.invalid &&
                reopenForm.get('reason')?.touched
              "
            ></textarea>
            <p
              class="mt-1 text-sm text-red-600 dark:text-red-400"
              *ngIf="
                reopenForm.get('reason')?.invalid &&
                reopenForm.get('reason')?.touched
              "
            >
              Reason is required
            </p>
          </div>
        </form>
      </div>

      <!-- Modal Footer -->
      <div
        class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3"
      >
        <button
          type="button"
          class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
          (click)="closeReopenModal()"
          [disabled]="loading"
        >
          Cancel
        </button>
        <button
          type="button"
          class="px-4 py-2 text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 rounded-md transition-colors disabled:opacity-50"
          [disabled]="reopenForm.invalid || loading"
          (click)="reopenOrder()"
        >
          {{ loading ? "Reopening..." : "Reopen Order" }}
        </button>
      </div>
    </div>
  </div>
</div>
