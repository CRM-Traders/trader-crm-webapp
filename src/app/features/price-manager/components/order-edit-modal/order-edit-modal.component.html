<div class="w-full">
  <!-- Modal Header -->
  <div *ngIf="orderData" class="mb-6">
    <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">
      Edit Order
    </h3>
    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
      Order ID: {{ orderData.orderId || orderData.id }}
      <span
        class="ml-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
        [ngClass]="{
          'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100':
            orderData.status === 1 || orderData.status === 2,
          'bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100':
            orderData.status === 3,
          'bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100':
            orderData.status === 4 ||
            orderData.status === 5 ||
            orderData.status === 6
        }"
      >
        {{ getOrderStatus(orderData.status) }}
      </span>
    </p>
  </div>

  <!-- Loading State -->
  <div *ngIf="loadingData" class="flex items-center justify-center h-[400px]">
    <div class="text-center">
      <div
        class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"
      ></div>
      <p class="text-gray-600 dark:text-gray-400">Loading order details...</p>
    </div>
  </div>

  <!-- Order Details -->
  <div
    *ngIf="!loadingData && orderData"
    class="grid grid-cols-1 lg:grid-cols-2 gap-6"
  >
    <!-- Left Side: TradingView Chart -->
    <div class="chart-section">
      <div class="chart-wrapper h-[400px]">
        <app-trading-view-chart
          [symbol]="currentSymbol() || 'BTCUSDT'"
          [interval]="'5'"
          [hideTopToolbar]="false"
          [hideSideToolbar]="true"
          [hideLegend]="false"
          [hideVolume]="false"
          [allowSymbolChange]="true"
          [autosize]="true"
          (parseEventData)="onChartEvent($event)"
        ></app-trading-view-chart>
      </div>
    </div>

    <!-- Right Side: Order Form -->
    <div class="form-section">
      <form [formGroup]="editForm" class="space-y-4">
        <!-- Row 1: Side, Status, Reason -->
        <div class="grid grid-cols-3 gap-4">
          <!-- Side -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Side
            </label>
            <div *ngIf="isEditing" class="grid grid-cols-2 gap-2">
              <label
                *ngFor="let option of sideOptions"
                class="flex items-center justify-center p-2.5 border rounded-lg cursor-pointer transition-all"
                [ngClass]="{
                  'border-blue-500 bg-blue-50 dark:bg-blue-900/20':
                    editForm.get('side')?.value === option.value,
                  'border-gray-300 dark:border-gray-600 hover:border-gray-400':
                    editForm.get('side')?.value !== option.value
                }"
              >
                <input
                  type="radio"
                  formControlName="side"
                  [value]="option.value"
                  class="sr-only"
                />
                <span
                  class="text-sm font-medium"
                  [ngClass]="
                    editForm.get('side')?.value === option.value
                      ? 'text-blue-600 dark:text-blue-400'
                      : option.class
                  "
                >
                  {{ option.label }}
                </span>
              </label>
            </div>
            <span
              *ngIf="!isEditing"
              class="inline-flex items-center px-3 py-2.5 rounded-md text-sm font-medium"
              [ngClass]="{
                'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100':
                  orderData.side === 1,
                'bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100':
                  orderData.side === 2
              }"
            >
              {{ getOrderSide(orderData.side) }}
            </span>
          </div>

          <!-- Status -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Status
            </label>
            <select
              *ngIf="isEditing"
              formControlName="status"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option *ngFor="let option of statusOptions" [value]="option.value">
                {{ option.label }}
              </option>
            </select>
            <span
              *ngIf="!isEditing"
              class="inline-flex items-center px-3 py-2.5 rounded-md text-sm font-medium"
              [ngClass]="{
                'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100':
                  orderData.status === 1 || orderData.status === 2,
                'bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100':
                  orderData.status === 3,
                'bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100':
                  orderData.status === 4 ||
                  orderData.status === 5 ||
                  orderData.status === 6
              }"
            >
              {{ getOrderStatus(orderData.status) }}
            </span>
          </div>

          <!-- Reason -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Reason
            </label>
            <input
              *ngIf="isEditing"
              type="text"
              formControlName="reason"
              placeholder="Enter reason for modification"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
            >
              {{ orderData.reason || "-" }}
            </span>
          </div>
        </div>

        <!-- Row 2: Volume, Symbol -->
        <div class="grid grid-cols-2 gap-4">
          <!-- Volume -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Volume
            </label>
            <input
              *ngIf="isEditing"
              type="number"
              formControlName="volume"
              (keydown)="preventInvalidNumberInput($event)"
              step="0.00000001"
              min="0"
              placeholder="Enter volume"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
            >
              {{ orderData.volume }}
            </span>
          </div>

          <!-- Symbol -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Symbol
            </label>
            <input
              type="text"
              formControlName="symbol"
              placeholder="Enter symbol"
              [disabled]="true"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-gray-100 cursor-not-allowed"
            />
          </div>
        </div>

        <!-- Row 3: Open Price, Position Open Time -->
        <div class="grid grid-cols-2 gap-4">
          <!-- Open Price -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Open Price
            </label>
            <div *ngIf="isEditing" class="relative">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <span class="text-gray-500 dark:text-gray-400 text-sm">$</span>
              </div>
              <input
                type="number"
                formControlName="openPrice"
                (keydown)="preventInvalidNumberInput($event)"
                step="0.00000001"
                min="0"
                placeholder="Enter open price"
                class="block w-full !pl-7 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white font-mono"
            >
              ${{ orderData.openPrice ?? orderData.price | number : "1.8-8" }}
            </span>
          </div>

          <!-- Position Open Time -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Position Open Time
            </label>
            <input
              *ngIf="isEditing"
              type="datetime-local"
              formControlName="positionOpenTime"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
            >
              {{
                orderData.positionOpenTime
                  ? (orderData.positionOpenTime | date : "medium")
                  : "-"
              }}
            </span>
          </div>
        </div>

        <!-- Row 4: Stop Loss, Take Profit -->
        <div class="grid grid-cols-2 gap-4">
          <!-- Stop Loss -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Stop Loss
            </label>
            <input
              *ngIf="isEditing"
              type="number"
              formControlName="stopLoss"
              (keydown)="preventInvalidNumberInput($event)"
              step="0.00000001"
              min="0"
              placeholder="Enter stop loss"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
            >
              {{
                orderData.stopLoss ?? orderData.stopPrice
                  ? "$" +
                    (orderData.stopLoss ?? orderData.stopPrice
                      | number : "1.8-8")
                  : "-"
              }}
            </span>
          </div>

          <!-- Take Profit -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Take Profit
            </label>
            <input
              *ngIf="isEditing"
              type="number"
              formControlName="takeProfit"
              (keydown)="preventInvalidNumberInput($event)"
              step="0.00000001"
              min="0"
              placeholder="Enter take profit"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
            >
              {{
                editForm.get("takeProfit")?.value
                  ? "$" + (editForm.get("takeProfit")?.value | number : "1.8-8")
                  : "-"
              }}
            </span>
          </div>
        </div>

        <!-- Row 5: Close Price, Position Close Time -->
        <div class="grid grid-cols-2 gap-4">
          <!-- Close Price -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Close Price
            </label>
            <div *ngIf="isEditing" class="relative">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <span class="text-gray-500 dark:text-gray-400 text-sm">$</span>
              </div>
              <input
                type="number"
                formControlName="closePrice"
                (keydown)="preventInvalidNumberInput($event)"
                step="0.00000001"
                min="0"
                placeholder="Enter close price"
                class="block w-full !pl-7 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white font-mono"
            >
              {{
                orderData.closePrice
                  ? "$" + (orderData.closePrice | number : "1.8-8")
                  : "-"
              }}
            </span>
          </div>

          <!-- Position Close Time -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Position Close Time
            </label>
            <input
              *ngIf="isEditing"
              type="datetime-local"
              formControlName="positionCloseTime"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
            >
              {{
                orderData.positionCloseTime
                  ? (orderData.positionCloseTime | date : "medium")
                  : "-"
              }}
            </span>
          </div>
        </div>

        <!-- Row 6: Commission, Swap -->
        <div class="grid grid-cols-2 gap-4">
          <!-- Commission -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Commission
            </label>
            <div *ngIf="isEditing" class="relative">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <span class="text-gray-500 dark:text-gray-400 text-sm">$</span>
              </div>
              <input
                type="number"
                formControlName="commission"
                (keydown)="preventInvalidNumberInput($event)"
                step="0.00000001"
                min="0"
                placeholder="Enter commission"
                class="block w-full !pl-7 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white font-mono"
            >
              {{
                orderData.commission
                  ? "$" + (orderData.commission | number : "1.8-8")
                  : "-"
              }}
            </span>
          </div>

          <!-- Swap -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Swap
            </label>
            <div *ngIf="isEditing" class="relative">
              <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
              >
                <span class="text-gray-500 dark:text-gray-400 text-sm">$</span>
              </div>
              <input
                type="number"
                formControlName="swap"
                (keydown)="preventInvalidNumberInput($event)"
                step="0.00000001"
                placeholder="Enter swap"
                class="block w-full !pl-7 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white font-mono"
            >
              {{
                orderData.swap ?? orderData.swaps
                  ? "$" + (orderData.swap ?? orderData.swaps | number : "1.8-8")
                  : "-"
              }}
            </span>
          </div>
        </div>

        <!-- Row 7: Floating P/L, Net Floating P/L, Margin -->
        <div class="grid grid-cols-3 gap-4">
          <!-- Floating P/L -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Floating P/L
            </label>
            <input
              type="text"
              [value]="
                getSellPL()
                  ? '$' + (getSellPL() | number : '1.8-8')
                  : getBuyPL()
                  ? '$' + (getBuyPL() | number : '1.8-8')
                  : '-'
              "
              readonly
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-gray-100 cursor-not-allowed"
            />
          </div>

          <!-- Net Floating P/L -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Net Floating P/L
            </label>
            <input
              type="text"
              [value]="
                orderData.realizedPnL != null
                  ? '$' + (orderData.realizedPnL | number : '1.2-8')
                  : '-'
              "
              readonly
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-gray-100 cursor-not-allowed"
            />
          </div>

          <!-- Margin -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Margin
            </label>
            <input
              type="text"
              [value]="
                getRequiredMargin()
                  ? '$' + (getRequiredMargin() | number : '1.4-4')
                  : '-'
              "
              readonly
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-gray-100 cursor-not-allowed"
            />
          </div>
        </div>
      </form>

      <!-- Modal Footer -->
      <div
        class="mt-8 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3"
      >

        <button
          *ngIf="isEditing"
          type="button"
          class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md transition-colors disabled:opacity-50"
          [disabled]="editForm.invalid || loading"
          (click)="saveOrder()"
        >
          {{ loading ? "Saving..." : "Save Changes" }}
        </button>

        <button
          type="button"
          class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
          (click)="cancelEdit()"
          [disabled]="loading"
        >
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Reopen Order Modal -->
  <div
    *ngIf="showReopenModal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
    (click)="closeReopenModal()"
  >
    <div
      class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4"
      (click)="$event.stopPropagation()"
    >
      <!-- Modal Header -->
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
          Reopen Order
        </h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
          Order ID: {{ orderData?.id }}
        </p>
      </div>

      <!-- Modal Body -->
      <div class="px-6 py-6">
        <form [formGroup]="reopenForm" class="space-y-4">
          <!-- Apply New Outcome -->
          <div class="flex items-center">
            <input
              type="checkbox"
              id="applyNewOutcome"
              formControlName="applyNewOutcome"
              class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
            />
            <label
              for="applyNewOutcome"
              class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              Apply New Outcome
            </label>
          </div>

          <!-- New Desired PnL -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
            >
              New Desired PnL <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              formControlName="newDesiredPnL"
              step="0.01"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
              [class.border-red-500]="
                reopenForm.get('newDesiredPnL')?.invalid &&
                reopenForm.get('newDesiredPnL')?.touched
              "
            />
            <p
              class="mt-1 text-sm text-red-600 dark:text-red-400"
              *ngIf="
                reopenForm.get('newDesiredPnL')?.invalid &&
                reopenForm.get('newDesiredPnL')?.touched
              "
            >
              New Desired PnL is required
            </p>
          </div>

          <!-- New Close Price -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
            >
              New Close Price <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              formControlName="newClosePrice"
              step="0.00000001"
              min="0"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
              [class.border-red-500]="
                reopenForm.get('newClosePrice')?.invalid &&
                reopenForm.get('newClosePrice')?.touched
              "
            />
            <p
              class="mt-1 text-sm text-red-600 dark:text-red-400"
              *ngIf="
                reopenForm.get('newClosePrice')?.invalid &&
                reopenForm.get('newClosePrice')?.touched
              "
            >
              New Close Price is required and must be positive
            </p>
          </div>

          <!-- Reason -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
            >
              Reason <span class="text-red-500">*</span>
            </label>
            <textarea
              formControlName="reason"
              rows="3"
              placeholder="Enter reason for reopening"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none"
              [class.border-red-500]="
                reopenForm.get('reason')?.invalid &&
                reopenForm.get('reason')?.touched
              "
            ></textarea>
            <p
              class="mt-1 text-sm text-red-600 dark:text-red-400"
              *ngIf="
                reopenForm.get('reason')?.invalid &&
                reopenForm.get('reason')?.touched
              "
            >
              Reason is required
            </p>
          </div>
        </form>
      </div>

      <!-- Modal Footer -->
      <div
        class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3"
      >
        <button
          type="button"
          class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
          (click)="closeReopenModal()"
          [disabled]="loading"
        >
          Cancel
        </button>
        <button
          type="button"
          class="px-4 py-2 text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 rounded-md transition-colors disabled:opacity-50"
          [disabled]="reopenForm.invalid || loading"
          (click)="reopenOrder()"
        >
          {{ loading ? "Reopening..." : "Reopen Order" }}
        </button>
      </div>
    </div>
  </div>
</div>
