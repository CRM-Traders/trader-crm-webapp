<div class="w-full">
  <!-- Loading State -->
  <div *ngIf="loadingData" class="flex items-center justify-center h-[400px]">
    <div class="text-center">
      <div
        class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"
      ></div>
      <p class="text-gray-600 dark:text-gray-400">Loading order details...</p>
    </div>
  </div>

  <!-- Order Details -->
  <div *ngIf="!loadingData && orderData">
    <!-- Modal Header -->
    <div
      class="modal-header border-b border-gray-200 dark:border-gray-700 px-6 py-4"
    >
      <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">
        {{ isEditing ? "Edit Order" : "Order Details" }}
      </h3>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
        Order ID: {{ orderData.id }}
        <span
          class="ml-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
          [ngClass]="{
            'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100':
              orderData.status === 1 || orderData.status === 2,
            'bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100':
              orderData.status === 3,
            'bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100':
              orderData.status === 4 ||
              orderData.status === 5 ||
              orderData.status === 6
          }"
        >
          {{ getOrderStatus(orderData.status) }}
        </span>
      </p>
      <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
        {{ orderData.tradingPairSymbol }}
      </p>
    </div>

    <!-- Modal Body -->
    <div class="modal-body px-6 py-6 max-h-[calc(100vh-200px)] overflow-y-auto">
      <form [formGroup]="editForm" class="max-w-4xl mx-auto">
        <!-- Basic Order Information -->
        <div class="mb-6">
          <h4
            class="text-base font-semibold text-gray-900 dark:text-gray-100 mb-4 pb-2 border-b border-gray-200 dark:border-gray-700"
          >
            Order Information
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <!-- Side (Buy/Sell) -->
            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >
                Side <span class="text-red-500">*</span>
              </label>
              <div *ngIf="isEditing" class="grid grid-cols-2 gap-3">
                <label
                  *ngFor="let option of sideOptions"
                  class="flex items-center justify-center p-3 border rounded-lg cursor-pointer transition-all"
                  [ngClass]="{
                    'border-blue-500 bg-blue-50 dark:bg-blue-900/20':
                      editForm.get('side')?.value === option.value,
                    'border-gray-300 dark:border-gray-600 hover:border-gray-400':
                      editForm.get('side')?.value !== option.value
                  }"
                >
                  <input
                    type="radio"
                    formControlName="side"
                    [value]="option.value"
                    class="sr-only"
                  />
                  <span
                    class="text-sm font-medium"
                    [ngClass]="
                      editForm.get('side')?.value === option.value
                        ? 'text-blue-600 dark:text-blue-400'
                        : option.class
                    "
                  >
                    {{ option.label }}
                  </span>
                </label>
              </div>
              <span
                *ngIf="!isEditing"
                class="inline-flex items-center px-3 py-2 rounded-md text-sm font-medium"
                [ngClass]="{
                  'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100':
                    orderData.side === 1,
                  'bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100':
                    orderData.side === 2
                }"
              >
                {{ getOrderSide(orderData.side) }}
              </span>
            </div>

            <!-- Status -->
            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >
                Status <span class="text-red-500">*</span>
              </label>
              <select
                *ngIf="isEditing"
                formControlName="status"
                class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                [class.border-red-500]="
                  editForm.get('status')?.invalid &&
                  editForm.get('status')?.touched
                "
              >
                <option [ngValue]="null" disabled>Select status</option>
                <option
                  *ngFor="let option of statusOptions"
                  [ngValue]="option.value"
                >
                  {{ option.label }}
                </option>
              </select>
              <span
                *ngIf="!isEditing"
                class="inline-flex items-center px-3 py-2 rounded-md text-sm font-medium"
                [ngClass]="{
                  'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100':
                    orderData.status === 1 || orderData.status === 2,
                  'bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100':
                    orderData.status === 3,
                  'bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100':
                    orderData.status === 4 ||
                    orderData.status === 5 ||
                    orderData.status === 6
                }"
              >
                {{ getOrderStatus(orderData.status) }}
              </span>
              <p
                class="mt-1 text-sm text-red-600 dark:text-red-400"
                *ngIf="
                  isEditing &&
                  editForm.get('status')?.invalid &&
                  editForm.get('status')?.touched
                "
              >
                Status is required
              </p>
            </div>

            <!-- Leverage -->
            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >
                Leverage
              </label>
              <input
                *ngIf="isEditing"
                type="number"
                formControlName="leverage"
                min="1"
                placeholder="Enter leverage"
                class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
              <span
                *ngIf="!isEditing"
                class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
              >
                {{ orderData.leverage || 1 }}x
              </span>
            </div>
          </div>
        </div>

        <!-- Price and Volume -->
        <div class="mb-6">
          <h4
            class="text-base font-semibold text-gray-900 dark:text-gray-100 mb-4 pb-2 border-b border-gray-200 dark:border-gray-700"
          >
            Price & Volume
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <!-- Open Price -->
            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >
                Open Price <span class="text-red-500">*</span>
              </label>
              <div *ngIf="isEditing" class="relative">
                <div
                  class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                >
                  <span class="text-gray-500 dark:text-gray-400 text-sm"
                    >$</span
                  >
                </div>
                <input
                  type="number"
                  formControlName="openPrice"
                  (keydown)="preventInvalidNumberInput($event)"
                  step="0.00000001"
                  min="0"
                  placeholder="Enter open price"
                  class="block w-full !pl-7 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  [class.border-red-500]="
                    editForm.get('openPrice')?.invalid &&
                    editForm.get('openPrice')?.touched
                  "
                />
              </div>
              <span
                *ngIf="!isEditing"
                class="block px-3 py-2 text-sm text-gray-900 dark:text-white font-mono"
              >
                ${{ orderData.price | number : "1.8-8" }}
              </span>
              <p
                class="mt-1 text-sm text-red-600 dark:text-red-400"
                *ngIf="
                  isEditing &&
                  editForm.get('openPrice')?.invalid &&
                  editForm.get('openPrice')?.touched
                "
              >
                Open Price is required and must be positive
              </p>
            </div>

            <!-- Volume -->
            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >
                Volume <span class="text-red-500">*</span>
              </label>
              <input
                *ngIf="isEditing"
                type="number"
                formControlName="volume"
                (keydown)="preventInvalidNumberInput($event)"
                step="0.00000001"
                min="0"
                placeholder="Enter volume"
                class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                [class.border-red-500]="
                  editForm.get('volume')?.invalid &&
                  editForm.get('volume')?.touched
                "
              />
              <span
                *ngIf="!isEditing"
                class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
              >
                {{ orderData.quantity | number : "1.8-8" }}
              </span>
              <p
                class="mt-1 text-sm text-red-600 dark:text-red-400"
                *ngIf="
                  isEditing &&
                  editForm.get('volume')?.invalid &&
                  editForm.get('volume')?.touched
                "
              >
                Volume is required and must be positive
              </p>
            </div>
          </div>
        </div>

        <!-- Risk Management -->
        <div class="mb-6">
          <h4
            class="text-base font-semibold text-gray-900 dark:text-gray-100 mb-4 pb-2 border-b border-gray-200 dark:border-gray-700"
          >
            Risk Management
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <!-- Stop Loss -->
            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >
                Stop Loss
              </label>
              <input
                *ngIf="isEditing"
                type="number"
                formControlName="stopLoss"
                (keydown)="preventInvalidNumberInput($event)"
                step="0.00000001"
                min="0"
                placeholder="Enter stop loss"
                class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
              <span
                *ngIf="!isEditing"
                class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
              >
                {{
                  orderData.stopPrice
                    ? "$" + (orderData.stopPrice | number : "1.8-8")
                    : "-"
                }}
              </span>
            </div>

            <!-- Take Profit -->
            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >
                Take Profit
              </label>
              <input
                *ngIf="isEditing"
                type="number"
                formControlName="takeProfit"
                (keydown)="preventInvalidNumberInput($event)"
                step="0.00000001"
                min="0"
                placeholder="Enter take profit"
                class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
              <span
                *ngIf="!isEditing"
                class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
              >
                {{
                  editForm.get("takeProfit")?.value
                    ? "$" +
                      (editForm.get("takeProfit")?.value | number : "1.8-8")
                    : "-"
                }}
              </span>
            </div>
          </div>
        </div>

        <!-- Financial Metrics -->
        <div class="mb-6">
          <h4
            class="text-base font-semibold text-gray-900 dark:text-gray-100 mb-4 pb-2 border-b border-gray-200 dark:border-gray-700"
          >
            Financial Metrics
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
            <!-- Sell P/L -->
            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >
                Sell P/L
              </label>
              <input
                type="text"
                [value]="
                  getSellPL() ? '$' + (getSellPL() | number : '1.8-8') : '-'
                "
                readonly
                class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-gray-100 cursor-not-allowed"
              />
            </div>

            <!-- Buy P/L -->
            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >
                Buy P/L
              </label>
              <input
                type="text"
                [value]="
                  getBuyPL() ? '$' + (getBuyPL() | number : '1.8-8') : '-'
                "
                readonly
                class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-gray-100 cursor-not-allowed"
              />
            </div>

            <!-- Required Margin -->
            <div>
              <label
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
              >
                Required Margin
              </label>
              <input
                type="text"
                [value]="
                  getRequiredMargin()
                    ? '$' + (getRequiredMargin() | number : '1.4-4')
                    : '-'
                "
                readonly
                class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-gray-100 cursor-not-allowed"
              />
            </div>
          </div>
        </div>

        <!-- Additional Information -->
        <div class="mb-6">
          <h4
            class="text-base font-semibold text-gray-900 dark:text-gray-100 mb-4 pb-2 border-b border-gray-200 dark:border-gray-700"
          >
            Additional Information
          </h4>
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Comment
            </label>
            <textarea
              *ngIf="isEditing"
              formControlName="comment"
              rows="3"
              placeholder="Enter comment (optional)"
              class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
            ></textarea>
            <span
              *ngIf="!isEditing"
              class="block px-3 py-2 text-sm text-gray-900 dark:text-white"
            >
              {{ editForm.get("comment")?.value || "-" }}
            </span>
          </div>
        </div>
      </form>
    </div>

    <!-- Modal Footer -->
    <div
      class="modal-footer border-t border-gray-200 dark:border-gray-700 px-6 py-4 flex justify-between items-center"
    >
      <!-- Left side: Cancel/Reopen Order button -->
      <div class="flex items-center gap-3">
        <button
          *ngIf="!isOrderClosed() && !isEditing"
          type="button"
          class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md transition-colors disabled:opacity-50"
          (click)="cancelOrder()"
          [disabled]="loading"
        >
          {{ loading ? "Cancelling..." : "Cancel Order" }}
        </button>
      </div>

      <!-- Right side: Edit/Save/Close buttons -->
      <div class="flex items-center gap-3">
        <button
          *ngIf="!isEditing"
          type="button"
          class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors"
          (click)="startEdit()"
        >
          Edit
        </button>

        <button
          *ngIf="isEditing"
          type="button"
          class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md transition-colors disabled:opacity-50"
          [disabled]="editForm.invalid || loading"
          (click)="saveOrder()"
        >
          {{ loading ? "Saving..." : "Save Changes" }}
        </button>

        <button
          type="button"
          class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
          (click)="isEditing ? cancelEdit() : onClose()"
          [disabled]="loading"
        >
          {{ isEditing ? "Cancel" : "Close" }}
        </button>
      </div>
    </div>
  </div>

  <!-- Reopen Order Modal -->
  <div
    *ngIf="showReopenModal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
    (click)="closeReopenModal()"
  >
    <div
      class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4"
      (click)="$event.stopPropagation()"
    >
      <!-- Modal Header -->
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
          Reopen Order
        </h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
          Order ID: {{ orderData?.id }}
        </p>
      </div>

      <!-- Modal Body -->
      <div class="px-6 py-6">
        <form [formGroup]="reopenForm" class="space-y-4">
          <!-- Apply New Outcome -->
          <div class="flex items-center">
            <input
              type="checkbox"
              id="applyNewOutcome"
              formControlName="applyNewOutcome"
              class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
            />
            <label
              for="applyNewOutcome"
              class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              Apply New Outcome
            </label>
          </div>

          <!-- New Desired PnL -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
            >
              New Desired PnL <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              formControlName="newDesiredPnL"
              step="0.01"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
              [class.border-red-500]="
                reopenForm.get('newDesiredPnL')?.invalid &&
                reopenForm.get('newDesiredPnL')?.touched
              "
            />
            <p
              class="mt-1 text-sm text-red-600 dark:text-red-400"
              *ngIf="
                reopenForm.get('newDesiredPnL')?.invalid &&
                reopenForm.get('newDesiredPnL')?.touched
              "
            >
              New Desired PnL is required
            </p>
          </div>

          <!-- New Close Price -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
            >
              New Close Price <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              formControlName="newClosePrice"
              step="0.00000001"
              min="0"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
              [class.border-red-500]="
                reopenForm.get('newClosePrice')?.invalid &&
                reopenForm.get('newClosePrice')?.touched
              "
            />
            <p
              class="mt-1 text-sm text-red-600 dark:text-red-400"
              *ngIf="
                reopenForm.get('newClosePrice')?.invalid &&
                reopenForm.get('newClosePrice')?.touched
              "
            >
              New Close Price is required and must be positive
            </p>
          </div>

          <!-- Reason -->
          <div>
            <label
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
            >
              Reason <span class="text-red-500">*</span>
            </label>
            <textarea
              formControlName="reason"
              rows="3"
              placeholder="Enter reason for reopening"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none"
              [class.border-red-500]="
                reopenForm.get('reason')?.invalid &&
                reopenForm.get('reason')?.touched
              "
            ></textarea>
            <p
              class="mt-1 text-sm text-red-600 dark:text-red-400"
              *ngIf="
                reopenForm.get('reason')?.invalid &&
                reopenForm.get('reason')?.touched
              "
            >
              Reason is required
            </p>
          </div>
        </form>
      </div>

      <!-- Modal Footer -->
      <div
        class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3"
      >
        <button
          type="button"
          class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
          (click)="closeReopenModal()"
          [disabled]="loading"
        >
          Cancel
        </button>
        <button
          type="button"
          class="px-4 py-2 text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 rounded-md transition-colors disabled:opacity-50"
          [disabled]="reopenForm.invalid || loading"
          (click)="reopenOrder()"
        >
          {{ loading ? "Reopening..." : "Reopen Order" }}
        </button>
      </div>
    </div>
  </div>
</div>
