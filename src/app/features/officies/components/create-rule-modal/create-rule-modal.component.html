<div class="w-full">
    <!-- Modal Header -->
    <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
      <h4 class="text-xl font-semibold text-gray-900 dark:text-white">
        {{ isEditing ? 'Edit Rule' : 'Create New Rule' }}
      </h4>
    </div>

    <!-- Modal Body -->
    <div class="px-6 py-6 max-h-[100vh] overflow-y-auto">
      <form [formGroup]="ruleForm" class="space-y-6">
        <!-- Rule Name and Category Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Rule Name -->
          <div>
            <label
              for="ruleName"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Rule name <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="ruleName"
              formControlName="ruleName"
              placeholder="Rule name"
              class="w-full px-3 py-2 border rounded-lg text-gray-900 dark:text-white bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
              [class.border-red-500]="
                ruleForm.get('ruleName')?.invalid &&
                ruleForm.get('ruleName')?.touched
              "
            />
            <p
              class="mt-1 text-sm text-red-600 dark:text-red-400"
              *ngIf="
                ruleForm.get('ruleName')?.invalid &&
                ruleForm.get('ruleName')?.touched
              "
            >
              <span *ngIf="ruleForm.get('ruleName')?.errors?.['required']"
                >Rule name is required</span
              >
            </p>
          </div>

          <!-- Rule Category -->
          <div>
            <label
              for="category"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Rule category <span class="text-red-500">*</span>
            </label>
            <select
              id="category"
              formControlName="category"
              class="w-full px-3 py-2 border rounded-lg text-gray-900 dark:text-white bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
              [class.border-red-500]="
                ruleForm.get('category')?.invalid &&
                ruleForm.get('category')?.touched
              "
            >
              <option value="">Select</option>
              <option [value]="RuleCategory.Brand">Brand</option>
              <option [value]="RuleCategory.Desk">Desk</option>
              <option [value]="RuleCategory.Team">Team</option>
              <option [value]="RuleCategory.Sale">Sale</option>
              <option [value]="RuleCategory.Retention">Retention</option>
            </select>
            <p
              class="mt-1 text-sm text-red-600 dark:text-red-400"
              *ngIf="
                ruleForm.get('category')?.invalid &&
                ruleForm.get('category')?.touched
              "
            >
              <span *ngIf="ruleForm.get('category')?.errors?.['required']"
                >Category is required</span
              >
            </p>
          </div>
        </div>

        <!-- Rule Priority and Type Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Rule Priority -->
          <div>
            <label
              for="priority"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Rule priority <span class="text-red-500">*</span>
            </label>
            <select
              id="priority"
              formControlName="priority"
              class="w-full px-3 py-2 border rounded-lg text-gray-900 dark:text-white bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
              [class.border-red-500]="
                ruleForm.get('priority')?.invalid &&
                ruleForm.get('priority')?.touched
              "
            >
              <option value="">Select</option>
              <option
                *ngFor="let priority of priorities"
                [value]="priority.value"
              >
                {{ priority.name }}
              </option>
            </select>
            <p
              class="mt-1 text-sm text-red-600 dark:text-red-400"
              *ngIf="
                ruleForm.get('priority')?.invalid &&
                ruleForm.get('priority')?.touched
              "
            >
              <span *ngIf="ruleForm.get('priority')?.errors?.['required']"
                >Priority is required</span
              >
            </p>
          </div>

          <!-- Rule Type -->
          <div>
            <label
              for="type"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Rule type <span class="text-red-500">*</span>
            </label>
            <select
              id="type"
              formControlName="type"
              class="w-full px-3 py-2 border rounded-lg text-gray-900 dark:text-white bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
              [class.border-red-500]="
                ruleForm.get('type')?.invalid &&
                ruleForm.get('type')?.touched
              "
            >
              <option value="">Select</option>
              <option *ngFor="let type of types" [value]="type.value">
                {{ type.name }}
              </option>
            </select>
            <p
              class="mt-1 text-sm text-red-600 dark:text-red-400"
              *ngIf="
                ruleForm.get('type')?.invalid &&
                ruleForm.get('type')?.touched
              "
            >
              <span *ngIf="ruleForm.get('type')?.errors?.['required']"
                >Type is required</span
              >
            </p>
          </div>
        </div>

        <!-- Countries and Languages Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Countries Selection -->
          <div class="relative">
            <label
              for="countries"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Countries
            </label>

            <!-- Custom Dropdown Button -->
            <button
              type="button"
              class="w-full px-3 py-2 border rounded-lg text-gray-900 dark:text-white bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors text-left flex justify-between items-center"
              (click)="toggleCountryDropdown()"
            >
              <span class="truncate">{{ getSelectedCountriesText() }}</span>
              <svg
                class="w-4 h-4 ml-2 transition-transform"
                [class.rotate-180]="countryDropdownOpen"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                ></path>
              </svg>
            </button>

            <!-- Dropdown Panel -->
            <div
              *ngIf="countryDropdownOpen"
              class="absolute !z-[99999] w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-64 overflow-hidden"
              style="z-index: 99999 !important;"
            >
              <!-- Search Input -->
              <div class="p-3 border-b border-gray-200 dark:border-gray-700">
                <input
                  #countrySearchInput
                  type="text"
                  placeholder="Search countries..."
                  class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  (input)="onCountrySearch($event)"
                  [value]="countrySearchTerm"
                />
              </div>

              <!-- Countries List -->
              <div class="max-h-48 overflow-y-auto">
                <div
                  *ngFor="let country of filteredCountries"
                  class="px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-sm text-gray-900 dark:text-white flex items-center"
                  (click)="toggleCountrySelection(country)"
                >
                  <input
                    type="checkbox"
                    [checked]="isCountrySelected(country)"
                    class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    (click)="$event.stopPropagation()"
                    (change)="toggleCountrySelection(country)"
                  />
                  {{ country.name }}
                </div>

                <!-- No results -->
                <div
                  *ngIf="filteredCountries.length === 0"
                  class="px-3 py-2 text-center text-sm text-gray-500 dark:text-gray-400"
                >
                  No countries found
                </div>
              </div>
            </div>
          </div>

          <!-- Languages Selection -->
          <div class="relative">
            <label
              for="languages"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Languages
            </label>

            <!-- Custom Dropdown Button -->
            <button
              type="button"
              class="w-full px-3 py-2 border rounded-lg text-gray-900 dark:text-white bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors text-left flex justify-between items-center"
              (click)="toggleLanguageDropdown()"
            >
              <span class="truncate">{{ getSelectedLanguagesText() }}</span>
              <svg
                class="w-4 h-4 ml-2 transition-transform"
                [class.rotate-180]="languageDropdownOpen"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                ></path>
              </svg>
            </button>

            <!-- Dropdown Panel -->
            <div
              *ngIf="languageDropdownOpen"
              class="absolute !z-[99999] w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-64 overflow-hidden"
              style="z-index: 99999 !important;"
            >
              <!-- Search Input -->
              <div class="p-3 border-b border-gray-200 dark:border-gray-700">
                <input
                  #languageSearchInput
                  type="text"
                  placeholder="Search languages..."
                  class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  (input)="onLanguageSearch($event)"
                  [value]="languageSearchTerm"
                />
              </div>

              <!-- Languages List -->
              <div class="max-h-48 overflow-y-auto">
                <div
                  *ngFor="let language of filteredLanguages"
                  class="px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-sm text-gray-900 dark:text-white flex items-center"
                  (click)="toggleLanguageSelection(language)"
                >
                  <input
                    type="checkbox"
                    [checked]="isLanguageSelected(language)"
                    class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    (click)="$event.stopPropagation()"
                    (change)="toggleLanguageSelection(language)"
                  />
                  {{ language.value }}
                </div>

                <!-- No results -->
                <div
                  *ngIf="filteredLanguages.length === 0"
                  class="px-3 py-2 text-center text-sm text-gray-500 dark:text-gray-400"
                >
                  No languages found
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Partners and Affiliate Referrals Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Partners (Affiliates) Selection -->
          <div class="relative">
            <label
              for="partners"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Partners (Affiliates)
            </label>

            <!-- Custom Dropdown Button -->
            <button
              type="button"
              class="w-full px-3 py-2 border rounded-lg text-gray-900 dark:text-white bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors text-left flex justify-between items-center"
              (click)="togglePartnerDropdown()"
            >
              <span class="truncate">{{ getSelectedPartnersText() }}</span>
              <svg
                class="w-4 h-4 ml-2 transition-transform"
                [class.rotate-180]="partnerDropdownOpen"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                ></path>
              </svg>
            </button>

            <!-- Dropdown Panel -->
            <div
              *ngIf="partnerDropdownOpen"
              class="absolute !z-[99999] w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-64 overflow-hidden"
              style="z-index: 99999 !important;"
            >
              <!-- Search Input -->
              <div class="p-3 border-b border-gray-200 dark:border-gray-700">
                <input
                  #partnerSearchInput
                  type="text"
                  placeholder="Search partners..."
                  class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  (input)="onPartnerSearch($event)"
                  [value]="partnerSearchTerm"
                />
              </div>

              <!-- Partners List -->
              <div class="max-h-48 overflow-y-auto">
                <div
                  *ngFor="let partner of filteredPartners"
                  class="px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-sm text-gray-900 dark:text-white flex items-center"
                  (click)="togglePartnerSelection(partner)"
                >
                  <input
                    type="checkbox"
                    [checked]="isPartnerSelected(partner)"
                    class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    (click)="$event.stopPropagation()"
                    (change)="togglePartnerSelection(partner)"
                  />
                  {{ partner.name }}
                </div>

                <!-- No results -->
                <div
                  *ngIf="filteredPartners.length === 0"
                  class="px-3 py-2 text-center text-sm text-gray-500 dark:text-gray-400"
                >
                  No partners found
                </div>
              </div>
            </div>
          </div>

          <!-- Affiliate Referrals Selection -->
          <div class="relative">
            <label
              for="affiliateReferrals"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Affiliate Referrals
            </label>

            <!-- Custom Dropdown Button -->
            <button
              type="button"
              class="w-full px-3 py-2 border rounded-lg text-gray-900 dark:text-white bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors text-left flex justify-between items-center"
              (click)="toggleAffiliateReferralDropdown()"
            >
              <span class="truncate">{{ getSelectedAffiliateReferralsText() }}</span>
              <svg
                class="w-4 h-4 ml-2 transition-transform"
                [class.rotate-180]="affiliateReferralDropdownOpen"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                ></path>
              </svg>
            </button>

            <!-- Dropdown Panel -->
            <div
              *ngIf="affiliateReferralDropdownOpen"
              class="absolute !z-[99999] w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-64 overflow-hidden"
              style="z-index: 99999 !important;"
            >
              <!-- Search Input -->
              <div class="p-3 border-b border-gray-200 dark:border-gray-700">
                <input
                  #affiliateReferralSearchInput
                  type="text"
                  placeholder="Search affiliate referrals..."
                  class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  (input)="onAffiliateReferralSearch($event)"
                  [value]="affiliateReferralSearchTerm"
                />
              </div>

              <!-- Affiliate Referrals List -->
              <div class="max-h-48 overflow-y-auto">
                <div
                  *ngFor="let referral of filteredAffiliateReferrals"
                  class="px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-sm text-gray-900 dark:text-white flex items-center"
                  (click)="toggleAffiliateReferralSelection(referral)"
                >
                  <input
                    type="checkbox"
                    [checked]="isAffiliateReferralSelected(referral)"
                    class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    (click)="$event.stopPropagation()"
                    (change)="toggleAffiliateReferralSelection(referral)"
                  />
                  {{ referral.name }}
                </div>

                <!-- No results -->
                <div
                  *ngIf="filteredAffiliateReferrals.length === 0"
                  class="px-3 py-2 text-center text-sm text-gray-500 dark:text-gray-400"
                >
                  No affiliate referrals found
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Operators Selection -->
        <div class="relative">
          <label
            for="operators"
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
          >
            Operators
          </label>

          <!-- Custom Dropdown Button -->
          <button
            type="button"
            class="w-full px-3 py-2 border rounded-lg text-gray-900 dark:text-white bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors text-left flex justify-between items-center"
            (click)="toggleOperatorDropdown()"
          >
            <span class="truncate">{{ getSelectedOperatorsText() }}</span>
            <svg
              class="w-4 h-4 ml-2 transition-transform"
              [class.rotate-180]="operatorDropdownOpen"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
              ></path>
            </svg>
          </button>

          <!-- Dropdown Panel -->
          <div
            *ngIf="operatorDropdownOpen"
            class="absolute !z-[99999] w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-64 overflow-hidden"
            style="z-index: 99999 !important;"
          >
            <!-- Search Input -->
            <div class="p-3 border-b border-gray-200 dark:border-gray-700">
              <input
                #operatorSearchInput
                type="text"
                placeholder="Search operators..."
                class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                (input)="onOperatorSearch($event)"
                [value]="operatorSearchTerm"
              />
            </div>

            <!-- Operators List -->
            <div class="max-h-48 overflow-y-auto">
              <div
                *ngFor="let operator of filteredOperators"
                class="px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-sm text-gray-900 dark:text-white flex items-center"
                (click)="toggleOperatorSelection(operator)"
              >
                <input
                  type="checkbox"
                  [checked]="isOperatorSelected(operator)"
                  class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                  (click)="$event.stopPropagation()"
                  (change)="toggleOperatorSelection(operator)"
                />
                <div class="flex-1">
                  <div class="font-medium">{{ operator.value }}</div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">{{ operator.email }}</div>
                </div>
              </div>

              <!-- No results -->
              <div
                *ngIf="filteredOperators.length === 0"
                class="px-3 py-2 text-center text-sm text-gray-500 dark:text-gray-400"
              >
                No operators found
              </div>
            </div>
          </div>
        </div>

        <!-- Source -->
        <div>
          <label
            for="sources"
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
          >
            Source
          </label>
          <input
            type="text"
            id="sources"
            formControlName="sources"
            placeholder="Source"
            class="w-full px-3 py-2 border rounded-lg text-gray-900 dark:text-white bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
          />
        </div>
      </form>
    </div>

          <!-- Modal Footer -->
      <div
        class="px-6 py-4 bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3"
      >
      <button
        type="button"
        class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
        (click)="onCancel()"
        [disabled]="isSubmitting"
      >
        Cancel
      </button>
      <button
        type="button"
        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        (click)="onSubmit()"
        [disabled]="ruleForm.invalid || isSubmitting"
      >
        <span class="flex items-center">
          <svg
            *ngIf="isSubmitting"
            class="animate-spin -ml-1 mr-2 h-4 w-4 text-white"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          {{
            isSubmitting
              ? isEditing
                ? 'Updating...'
                : 'Creating...'
              : isEditing
              ? 'Update Rule'
              : 'Create rule'
          }}
        </span>
      </button>
    </div>
  </div>